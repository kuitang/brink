<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Brinksmanship{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/htmx.min.js') }}" defer></script>
</head>
<body class="theme-{{ theme|default('default') }} {% block body_class %}{% endblock %}">
    <header>
        <div class="container">
            <a href="{{ url_for('lobby.index') }}" class="site-title">Brinksmanship</a>
            <nav>
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('lobby.index') }}">Games</a>
                    <a href="{{ url_for('lobby.new_game') }}">New Game</a>
                    <a href="{{ url_for('scenarios.index') }}">Scenarios</a>
                    <a href="{{ url_for('leaderboard.index') }}">Leaderboards</a>
                    <a href="{{ url_for('manual.index') }}">Rules</a>
                    <a href="{{ url_for('auth.logout') }}">Logout ({{ current_user.username }})</a>
                {% else %}
                    <a href="{{ url_for('scenarios.index') }}">Scenarios</a>
                    <a href="{{ url_for('leaderboard.index') }}">Leaderboards</a>
                    <a href="{{ url_for('manual.index') }}">Rules</a>
                    <a href="{{ url_for('auth.login') }}">Login</a>
                    <a href="{{ url_for('auth.register') }}">Register</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <span>A game-theoretic strategy simulation</span>
                <div class="theme-switcher">
                    <label for="theme-select">Theme:</label>
                    <select id="theme-select" onchange="switchTheme(this.value)">
                        {% for t in available_themes %}
                        <option value="{{ t }}" {% if t == theme %}selected{% endif %}>{{ t|replace('-', ' ')|title }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </footer>
    <script>
        function switchTheme(theme) {
            // Set cookie for persistence
            document.cookie = "theme=" + theme + ";path=/;max-age=31536000";
            // Reload page to apply theme
            window.location.reload();
        }

        // Global HTMX error handling
        document.addEventListener('htmx:sendError', function(evt) {
            console.error('HTMX send error:', evt.detail);
            showHtmxError('Network error: Could not reach server. Please check your connection.');
        });

        document.addEventListener('htmx:timeout', function(evt) {
            console.error('HTMX timeout:', evt.detail);
            showHtmxError('Request timed out. The server may be busy. Please try again.');
        });

        document.addEventListener('htmx:responseError', function(evt) {
            console.error('HTMX response error:', evt.detail);
            var status = evt.detail.xhr ? evt.detail.xhr.status : 'unknown';
            var msg = 'Server error (HTTP ' + status + '). ';
            if (status === 500) {
                msg += 'This may be an API configuration issue.';
            } else if (status === 504 || status === 502) {
                msg += 'The server is taking too long to respond.';
            }
            showHtmxError(msg);
        });

        function showHtmxError(message) {
            // Create or update error banner
            var banner = document.getElementById('htmx-error-banner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'htmx-error-banner';
                banner.className = 'flash flash-error';
                banner.style.cssText = 'position: fixed; top: 60px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 600px; padding: 12px 40px 12px 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
                document.body.appendChild(banner);
            }
            banner.innerHTML = message + ' <button onclick="this.parentElement.remove()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px;">&times;</button>';
            banner.style.display = 'block';

            // Auto-hide after 10 seconds
            setTimeout(function() {
                if (banner) banner.remove();
            }, 10000);
        }
    </script>
</body>
</html>
