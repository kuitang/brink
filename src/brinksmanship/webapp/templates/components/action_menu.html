{# Action selection menu with htmx #}
{# Timeout of 90 seconds for LLM opponent responses #}
<form id="action-form" hx-post="{{ url_for('game.submit_action', game_id=game_id) }}"
      hx-target="#game-board"
      hx-swap="innerHTML"
      hx-indicator="#thinking"
      hx-disabled-elt="button[type='submit']"
      hx-request='{"timeout": 90000}'>

    <div class="hide-on-request">
        <div class="action-header">
            <span class="action-prompt">Choose Your Action</span>
            <span class="text-muted">(1-{{ actions|length }})</span>
            {% if state.turn > 4 and state.stability > 2 %}
            <button type="button" class="settlement-btn" onclick="openSettlementPanel()"
                    title="Negotiate a settlement to end the crisis">
                Negotiate Settlement
            </button>
            {% endif %}
        </div>
        <div class="action-menu">
            {% for action in actions %}
            <button type="submit" name="action_id" value="{{ action.id }}"
                    class="action-btn {{ action.type }}"
                    data-action-index="{{ loop.index }}"
                    title="{{ action.description }}">
                <span class="action-key">{{ loop.index }}</span>
                <span class="action-type-indicator {{ action.type }}">
                    {% if action.type == 'cooperative' %}
                    &#x1F54A;
                    {% else %}
                    &#x2694;
                    {% endif %}
                </span>
                <div class="action-content">
                    <span class="action-name">{{ action.name }}</span>
                    <span class="action-mechanics">{{ action.mechanics_hint }}{% if action.cost > 0 %} &middot; {{ action.cost }} resources{% endif %}</span>
                </div>
            </button>
            {% endfor %}
        </div>
    </div>

    <div id="thinking" class="htmx-indicator">
        {% include "components/opponent_thinking.html" %}
    </div>
</form>

<script>
(function() {
    // Keyboard shortcuts for actions (1-9) with request-in-flight protection
    let requestInFlight = false;

    document.body.addEventListener('htmx:beforeRequest', function(e) {
        if (e.detail.elt.id === 'action-form') {
            requestInFlight = true;
            // Hide any previous error
            var errorEl = document.getElementById('action-error');
            if (errorEl) errorEl.style.display = 'none';
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(e) {
        if (e.detail.elt.id === 'action-form') {
            requestInFlight = false;

            // Check for errors
            if (!e.detail.successful) {
                var errorEl = document.getElementById('action-error');
                if (!errorEl) {
                    errorEl = document.createElement('div');
                    errorEl.id = 'action-error';
                    errorEl.className = 'flash flash-error';
                    errorEl.style.marginTop = '12px';
                    document.getElementById('action-form').appendChild(errorEl);
                }
                var msg = 'Failed to submit action. ';
                if (e.detail.xhr && e.detail.xhr.status === 0) {
                    msg += 'Network error or timeout.';
                } else if (e.detail.xhr) {
                    msg += 'Server returned ' + e.detail.xhr.status + '.';
                }
                errorEl.textContent = msg + ' Please try again.';
                errorEl.style.display = 'block';

                // Re-enable buttons
                var buttons = document.querySelectorAll('#action-form button[type="submit"]');
                buttons.forEach(function(btn) { btn.disabled = false; });

                // Hide thinking indicator
                var thinking = document.getElementById('thinking');
                if (thinking) thinking.classList.remove('htmx-request');
            }
        }
    });

    document.addEventListener('keydown', function(e) {
        // Ignore if typing in an input field or request in flight
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (requestInFlight) return;

        // Check for number keys 1-9
        const key = parseInt(e.key);
        if (key >= 1 && key <= 9) {
            const btn = document.querySelector(`[data-action-index="${key}"]`);
            if (btn && !btn.disabled) {
                e.preventDefault();
                btn.click();
            }
        }
    });
})();
</script>
